# http://www.maths.bath.ac.uk/~jjf23/mixchange/split.html

library(lme4)
library(faraway)
head(irrigation)
summary(irrigation)
library(ggplot2)
ggplot(irrigation, aes(y=yield, x=field, shape=variety, color=irrigation)) + geom_point()

#lmer approach:
mmod <- lmer(yield ~ irrigation * variety + (1|field),data=irrigation)
print(summary(mmod),correlation=FALSE)
anova(mmod)
confint(mmod)

library(nlme)
mmod2 <- lme(yield ~ irrigation*variety, random=~1|field, irrigation)
summary(mmod2); anova(mmod2)

#aov approach:
lmod <- aov(yield ~ irrigation*variety + Error(field), irrigation)
summary(lmod)

library(gsheet)
splityield <- read.csv(text = 
                         gsheet2text('https://docs.google.com/spreadsheets/d/1THGClMt_bkP4lYIWqpI3S5mg0uRlGLrP48aVTTIvnX4/edit?usp=sharing',
                                     format ='csv'))
head(splityield)
summary(splityield)
ggplot(splityield, aes(y=yield, x=block, shape=irrigation, color=fertilizer)) + geom_point()
str(splityield)

#lmer approach:
fita <- lmer(yield ~ irrigation * density * fertilizer + (1|block), data = splityield)
summary(fita, correlation = F)
anova(fita)
confint(fita)

#... and without interactions:

fit_noin <- lmer(yield ~ irrigation + density + fertilizer + (1|block), data = splityield)
summary(fit_noin, correlation = F)
anova(fit_noin)
confint(fit_noin)

library(pbkrtest)
KRmodcomp(fita, fit_noin)

#nlme:

library(nlme)
fita1 <- lme(yield ~ irrigation * density * fertilizer, random=~1|block, splityield)
summary(fita1); anova(fita1)


#aov approach:

fitb <- aov(yield ~ irrigation*density*fertilizer + Error(block), splityield)
summary(fitb)
